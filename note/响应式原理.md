# 响应式原理

## 01. 含义
响应式就是指当数据发生变化后，会重新对页面进行渲染。想要实现这个过程就需要：
- 侦测数据的变化（数据劫持 / 数据代理）。
- 收集试图依赖了哪些数据（依赖收集）。
- 数据变化时，自动「通知」需要更新的新视图部分（发布订阅模式）。

在 vue2 中通过 `Object.defaultProperty()` 来实现，在 vue3 中通过 `Proxy` 来实现。



## 02. Object.defineProperty()
`Object.defineProperty()` 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。

通过 `Object.defineProperty` 设定对象属性的 `setter/getter` 方法对收集的依赖项进行监听，通过 `getter` 进行依赖收集，每一个 `setter` 就相当于一个观察者，在属性被访问和修改时通知变化，进而更新视图数据。

```js
function observe(obj) {
  if (!obj || typeof obj !== 'obj') {
    return;
  }

  Object.keys(obj).forEach(key => {
    defineReact(obj, key, obj[key]);
  });

  function defineReactive(obj, key, value) {
    observe(value);
    Object.defineProperty(obj, key, {
      get: function reactiveGetter() {
        console.log('get', value);
        return value;
      }

      set: function reactiveSetter(newVal) {
        observe(newVal);
        if (newVal !== value) {
          console.log('set', newValue);
          value = newVal;
        }
      }
    })
  }
}
```

由于 `Object.defineProperty` 无法追踪新增属性和删除属性。`Vue` 会在初始化实例时对属性执行 `getter/setter` 转化过程，`vue` 不能检测到对象属性的添加和删除，所以属性必须在 `data` 对象上存在才能让Vue转换它，这样才能让它是响应的。

`Object.defineProperty` 也不能监听数组的变化。


如果要新增属性可以使用 `Vue.set()` 添加响应式属性，可以通过 `vm.$delete` 删除。

![vue2响应式](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/2/8/1617554b425a3431~tplv-t2oaga2asx-watermark.awebp)



## 03. Proxy
vue3 是基于 `Proxy` 来实现数据的响应式。`Proxy` 对象用于创建一个对象的代理，从而实现基本的拦截和自定义。`Proxy` 相对于 `Object.defineProperty` 的优势：

- 可以直接监听对象而非属性，不需要遍历对象的每个属性。
- 可以直接监听数组的变化。
- `Proxy` 返回一个新对象，可以只操作新的对象达到目的。而 `Object.defineProperty` 只能遍历对象属性直接修改。

```js
let handler = {
  get(target, key) {
    if (typeof target[key] == 'object' && target[key] != null) {
      return new Proxy(target[key], handler);
    }
    return Reflect.get(target, key);
  },

  set(target, key, value) {
    if (key === 'length') return true;
    return Reflect.set(target, key, value);
  }
}

let obj = {
  name: '前端工匠',
  age: { age: 100 },
  arr: [1, 2, 3]
}

let proxy = new Proxy(obj, handler);
proxy.name = 'vue'，
proxy.arr[0] = 5
```


## 参考
- https://juejin.cn/post/6844903882208837640